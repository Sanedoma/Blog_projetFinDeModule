{% extends 'base.html.twig' %}

{% block title %}Accueil{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">Blog - Accueil</h2>
                        {% if app.user and is_granted('ROLE_USER') %}
                            <a href="{{ path('app_post_new') }}" class="btn btn-light btn-sm">
                                <i class="fas fa-plus"></i> Rédiger un article
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filters Section -->
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter"></i> Filtrer les articles</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ path('app_home') }}" class="row g-3">
                                <div class="col-md-3">
                                    <label for="category" class="form-label">Catégorie</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="">-- Toutes les catégories --</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}" {% if selectedCategory == category.id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="author" class="form-label">Auteur</label>
                                    <select class="form-select" id="author" name="author">
                                        <option value="">-- Tous les auteurs --</option>
                                        {% for author in authors %}
                                            <option value="{{ author.id }}" {% if selectedAuthor == author.id %}selected{% endif %}>{{ author.firstName }} {{ author.lastName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="date_from" class="form-label">Du</label>
                                    <input type="date" class="form-control" id="date_from" name="date_from" value="{{ selectedDateFrom }}">
                                </div>
                                <div class="col-md-2">
                                    <label for="date_to" class="form-label">Au</label>
                                    <input type="date" class="form-control" id="date_to" name="date_to" value="{{ selectedDateTo }}">
                                </div>
                                <div class="col-md-2 d-flex gap-2 align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search"></i> Filtrer
                                    </button>
                                    <a href="{{ path('app_home') }}" class="btn btn-secondary w-100">
                                        <i class="fas fa-redo"></i> Réinitialiser
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Posts Grid -->
                    {% if pagination.items %}
                        <div class="row">
                            {% for post in pagination %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        {% if post.picture %}
                                            <img src="{{ post.picture }}" class="card-img-top" alt="{{ post.title }}" style="height: 250px; object-fit: cover;">
                                        {% endif %}
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">{{ post.title }}</h5>
                                            <p class="card-text text-muted flex-grow-1">{{ post.content|slice(0, 100) }}...</p>
                                            <div class="d-flex flex-wrap gap-2 mb-3">
                                                <a href="{{ path('app_home', {'author': post.user.id}) }}" class="badge bg-info text-decoration-none">
                                                    <i class="fas fa-user"></i> {{ post.user.firstName }} {{ post.user.lastName }}
                                                </a>
                                                <a href="{{ path('app_home', {'category': post.category.id}) }}" class="badge bg-secondary text-decoration-none">
                                                    <i class="fas fa-tag"></i> {{ post.category.name }}
                                                </a>
                                            </div>
                                            <small class="text-muted mb-3">
                                                <i class="fas fa-calendar"></i> {{ post.publishAt|date('d/m/Y') }}
                                                <span class="ms-2"><i class="fas fa-comments"></i> {{ post.comments|length }} commentaire(s)</span>
                                            </small>
                                            <div class="d-flex gap-2">
                                                <a href="{{ path('app_post_show', {'id': post.id}) }}" class="btn btn-sm btn-primary flex-grow-1">
                                                    <i class="fas fa-eye"></i> Lire la suite
                                                </a>
                                                {% if app.user and (post.user === app.user or is_granted('ROLE_ADMIN')) %}
                                                    <a href="{{ path('app_post_edit', {'id': post.id}) }}" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Pagination Controls -->
                        <nav aria-label="Page navigation" class="mt-5">
                            <ul class="pagination justify-content-center">
                                {% if pagination.pageCount > 1 %}
                                    {# Previous page #}
                                    {% if not pagination.isFirstPage %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_home', query_params({'page': 1})) }}">
                                                <i class="fas fa-chevron-left"></i> Première
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_home', query_params({'page': pagination.currentPageNumber - 1})) }}">
                                                Précédent
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-chevron-left"></i> Première</span>
                                        </li>
                                        <li class="page-item disabled">
                                            <span class="page-link">Précédent</span>
                                        </li>
                                    {% endif %}

                                    {# Page numbers #}
                                    {% for page in 1..pagination.pageCount %}
                                        {% if page == pagination.currentPageNumber %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ path('app_home', query_params({'page': page})) }}">{{ page }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {# Next page #}
                                    {% if not pagination.isLastPage %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_home', query_params({'page': pagination.currentPageNumber + 1})) }}">
                                                Suivant
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_home', query_params({'page': pagination.pageCount})) }}">
                                                Dernière <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Suivant</span>
                                        </li>
                                        <li class="page-item disabled">
                                            <span class="page-link">Dernière <i class="fas fa-chevron-right"></i></span>
                                        </li>
                                    {% endif %}
                                {% endif %}
                            </ul>
                        </nav>

                        {# Pagination info #}
                        <div class="text-center text-muted mt-3">
                            <small>Page {{ pagination.currentPageNumber }} sur {{ pagination.pageCount }} - {{ pagination.totalItemCount }} article(s) au total</small>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center py-5">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p class="mb-0">Aucun article ne correspond à vos critères de filtre.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
